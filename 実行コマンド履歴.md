# Amazon Bedrock AgentCore Gateway と MyKintone MCP Server 構築手順

## 概要
Amazon Bedrock AgentCore Gateway を使用してリモートMCP Serverを作成し、kintone連携機能を実装するプロジェクトの構築手順です。

## 構築手順

### 1. Amazon Bedrock AgentCore Gateway の作成

#### コマンド
```bash
uv run agentcore gateway create --name MyKintoneGateway --region YOUR_REGION
```

#### 結果
- **Gateway ARN**: `arn:aws:bedrock-agentcore:YOUR_REGION:ACCOUNT_ID:gateway/YOUR_GATEWAY_ID`
- **Gateway URL**: `https://YOUR_GATEWAY_ID.gateway.bedrock-agentcore.YOUR_REGION.amazonaws.com/mcp`
- **ステータス**: READY
- **認証**: Cognito認証が自動設定

### 2. kintone MCP Server リポジトリのクローン

#### コマンド
```bash
git clone https://github.com/kintone/mcp-server.git kintone-mcp-server
```

#### 結果
公式のkintone MCP Serverリポジトリを正常にクローンし、実装パターンを参考にしてMyKintoneプロジェクトを設計します。

### 3. MyKintone プロジェクトの作成

Node.js TypeScript プロジェクトを初期化し、必要なファイルを作成します：

- `MyKintone/src/index.ts` - Lambda関数のメイン実装
- `MyKintone/package.json` - プロジェクト設定
- `MyKintone/tsconfig.json` - TypeScript設定
- `MyKintone/openapi.yaml` - API仕様書
- `MyKintone/kintone-tools-schema.json` - ツールスキーマ定義
- `MyKintone/README.md` - プロジェクトドキュメント

### 4. Lambda関数のデプロイ

#### コマンド
```bash
# パッケージのビルド
cd MyKintone
npm run build
zip -r mykintone-lambda.zip dist/ node_modules/ package.json

# Lambda関数の作成
aws lambda create-function \
  --function-name MyKintoneMCPServer \
  --runtime nodejs18.x \
  --role arn:aws:iam::ACCOUNT_ID:role/lambda-execution-role \
  --handler dist/index.handler \
  --zip-file fileb://mykintone-lambda.zip \
  --timeout 30 \
  --memory-size 256 \
  --region YOUR_REGION

# 環境変数の設定
aws lambda update-function-configuration \
  --function-name MyKintoneMCPServer \
  --environment Variables='{
    "KINTONE_BASE_URL":"https://your-domain.cybozu.com",
    "KINTONE_USERNAME":"your-username",
    "KINTONE_PASSWORD":"your-password"
  }' \
  --region YOUR_REGION
```

#### 結果
- **Lambda Function ARN**: `arn:aws:lambda:YOUR_REGION:ACCOUNT_ID:function:MyKintoneMCPServer`
- **ランタイム**: Node.js 18.x
- **メモリ**: 256MB
- **タイムアウト**: 30秒
- **環境変数**: kintone認証情報を設定

### 5. Lambda関数の更新

ユーザー名・パスワード認証に対応し、AWS公式仕様に準拠するよう実装を更新します：

#### コマンド
```bash
# 更新されたコードのデプロイ
npm run build
zip -r mykintone-lambda-updated.zip dist/ node_modules/ package.json

aws lambda update-function-code \
  --function-name MyKintoneMCPServer \
  --zip-file fileb://mykintone-lambda-updated.zip \
  --region YOUR_REGION
```

### 6. Lambda関数のテスト

#### コマンド
```bash
aws lambda invoke \
  --function-name MyKintoneMCPServer \
  --payload file://test-payload.json \
  --region YOUR_REGION \
  response.json
```

#### テストペイロード（test-payload.json）
```json
{
  "tool": "get-apps",
  "params": {}
}
```

#### 結果
Lambda関数が正常に動作し、kintoneアプリ一覧を取得できることを確認します。

### 7. AgentCore Gateway Target の作成

#### コマンド
```bash
uv run agentcore gateway create-target \
  --gateway-arn arn:aws:bedrock-agentcore:YOUR_REGION:ACCOUNT_ID:gateway/YOUR_GATEWAY_ID \
  --target-payload file://target-payload.json
```

#### Target設定ファイル（target-payload.json）
```json
{
  "lambdaArn": "arn:aws:lambda:YOUR_REGION:ACCOUNT_ID:function:MyKintoneMCPServer",
  "toolSchema": {
    "inlinePayload": [
      // kintone操作用の7つのツール定義
    ]
  }
}
```

#### 結果
Target ID（YOUR_TARGET_ID）が生成され、以下のツールが利用可能になります：
- kintone-get-records（レコード取得）
- kintone-get-app（アプリ情報取得）
- kintone-get-apps（アプリ一覧取得）
- kintone-add-records（レコード追加）
- kintone-get-form-fields（フォームフィールド取得）
- kintone-update-records（レコード更新）
- kintone-delete-records（レコード削除）

### 8. Gateway設定の確認

#### コマンド
```bash
uv run agentcore gateway list --region YOUR_REGION
uv run agentcore gateway list-targets \
  --gateway-arn arn:aws:bedrock-agentcore:YOUR_REGION:ACCOUNT_ID:gateway/YOUR_GATEWAY_ID
uv run agentcore gateway get-target \
  --gateway-arn arn:aws:bedrock-agentcore:YOUR_REGION:ACCOUNT_ID:gateway/YOUR_GATEWAY_ID \
  --target-id YOUR_TARGET_ID
```

これらのコマンドでGateway、Target、ツールスキーマが正常に設定されていることを確認します。

## 構築完了後の構成

### AWS リソース
- **Bedrock AgentCore Gateway**: MyKintoneGateway（YOUR_REGION）
- **Lambda Function**: MyKintoneMCPServer（Node.js 18.x）
- **IAM Role**: lambda-execution-role（Lambda実行用）
- **Target**: YOUR_TARGET_ID（Gateway内のターゲット）

### 認証設定
- **kintone認証**: ユーザー名・パスワード方式
- **Gateway認証**: Cognito認証（自動設定）
- **Lambda権限**: 基本実行権限 + CloudWatch Logs

### 実装されたツール
1. **kintone-get-records**: レコード検索・取得
2. **kintone-get-app**: アプリ情報取得
3. **kintone-get-apps**: アプリ一覧取得
4. **kintone-add-records**: レコード追加
5. **kintone-get-form-fields**: フォームフィールド取得
6. **kintone-update-records**: レコード更新
7. **kintone-delete-records**: レコード削除

## 9. Cognito認証設定とトークン取得

### 9.1 Cognito設定確認

#### コマンド
```bash
# User Pool詳細確認
aws cognito-idp describe-user-pool --user-pool-id YOUR_USER_POOL_ID --region YOUR_REGION

# User Pool Client詳細確認
aws cognito-idp describe-user-pool-client --user-pool-id YOUR_USER_POOL_ID --client-id YOUR_CLIENT_ID --region YOUR_REGION
```

### 9.2 テストユーザーの作成

#### コマンド
```bash
# ユーザー作成
aws cognito-idp admin-create-user --user-pool-id YOUR_USER_POOL_ID --username YOUR_USERNAME --temporary-password YOUR_TEMP_PASSWORD --message-action SUPPRESS --region YOUR_REGION

# パスワード永続化
aws cognito-idp admin-set-user-password --user-pool-id YOUR_USER_POOL_ID --username YOUR_USERNAME --password YOUR_PASSWORD --permanent --region YOUR_REGION

# 認証フロー有効化
aws cognito-idp update-user-pool-client \
  --user-pool-id YOUR_USER_POOL_ID \
  --client-id YOUR_CLIENT_ID \
  --explicit-auth-flows ALLOW_ADMIN_USER_PASSWORD_AUTH ALLOW_USER_PASSWORD_AUTH ALLOW_REFRESH_TOKEN_AUTH \
  --region YOUR_REGION
```

### 9.3 認証トークンの取得

#### SECRET_HASHの計算
```bash
echo -n "YOUR_USERNAME+YOUR_CLIENT_ID" | openssl dgst -sha256 -hmac "YOUR_CLIENT_SECRET" -binary | base64
```

#### 認証実行
```bash
aws cognito-idp admin-initiate-auth \
  --user-pool-id YOUR_USER_POOL_ID \
  --client-id YOUR_CLIENT_ID \
  --auth-flow ADMIN_USER_PASSWORD_AUTH \
  --auth-parameters USERNAME=YOUR_USERNAME,PASSWORD='YOUR_PASSWORD',SECRET_HASH=YOUR_SECRET_HASH \
  --region YOUR_REGION
```

### 9.4 Gateway認証テスト

#### コマンド
```bash
curl -X POST \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc": "2.0", "id": 1, "method": "tools/list"}' \
  https://YOUR_GATEWAY_ID.gateway.bedrock-agentcore.YOUR_REGION.amazonaws.com/mcp
```

このコマンドで利用可能なkintoneツール一覧が取得できることを確認します。

## 10. MCP ツールの呼び出し

### 10.1 環境変数の設定（zsh環境）

```bash
# Cognito認証情報
export USER_POOL_ID="YOUR_USER_POOL_ID"
export CLIENT_ID="YOUR_CLIENT_ID"
export CLIENT_SECRET="YOUR_CLIENT_SECRET"
export USERNAME="YOUR_USERNAME"
export PASSWORD="YOUR_PASSWORD"
export REGION="YOUR_REGION"

# SECRET_HASHの計算
export SECRET_HASH=$(echo -n "${USERNAME}+${CLIENT_ID}" | openssl dgst -sha256 -hmac "${CLIENT_SECRET}" -binary | base64)

# 認証トークンの取得
export ACCESS_TOKEN=$(aws cognito-idp admin-initiate-auth \
  --user-pool-id "${USER_POOL_ID}" \
  --client-id "${CLIENT_ID}" \
  --auth-flow ADMIN_USER_PASSWORD_AUTH \
  --auth-parameters "USERNAME=${USERNAME},PASSWORD=${PASSWORD},SECRET_HASH=${SECRET_HASH}" \
  --region "${REGION}" \
  --query 'AuthenticationResult.AccessToken' \
  --output text)

# Gateway URL
export GATEWAY_URL="https://YOUR_GATEWAY_ID.gateway.bedrock-agentcore.YOUR_REGION.amazonaws.com/mcp"
```

### 10.2 kintoneアプリ一覧の取得

```bash
curl -X POST \
  -H "Authorization: Bearer ${ACCESS_TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "tools/call",
    "params": {
      "name": "MyKintoneTarget___kintone-get-apps",
      "arguments": {}
    }
  }' \
  "${GATEWAY_URL}"
```

### 10.3 特定アプリの詳細情報取得

```bash
curl -X POST \
  -H "Authorization: Bearer ${ACCESS_TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "tools/call",
    "params": {
      "name": "MyKintoneTarget___kintone-get-app",
      "arguments": {
        "appId": "APP_ID"
      }
    }
  }' \
  "${GATEWAY_URL}"
```

### 10.4 利用可能ツール一覧の確認

```bash
curl -X POST \
  -H "Authorization: Bearer ${ACCESS_TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc": "2.0", "id": 1, "method": "tools/list"}' \
  "${GATEWAY_URL}"
```
## 設定値の置換について

このテンプレートファイルでは、以下の値を実際の環境に合わせて置換してください：

- `YOUR_REGION`: AWSリージョン（例: us-east-1）
- `ACCOUNT_ID`: AWSアカウントID
- `YOUR_GATEWAY_ID`: Gateway ID
- `YOUR_TARGET_ID`: Target ID
- `YOUR_USER_POOL_ID`: Cognito User Pool ID
- `YOUR_CLIENT_ID`: Cognito Client ID
- `YOUR_CLIENT_SECRET`: Cognito Client Secret
- `YOUR_USERNAME`: Cognitoユーザー名
- `YOUR_PASSWORD`: Cognitoパスワード
- `YOUR_TEMP_PASSWORD`: 一時パスワード
- `APP_ID`: 取得したいkintoneアプリのID

## 注意事項

- 実際の機密情報（パスワード、トークン、シークレット等）は絶対にGitリポジトリにコミットしないでください
- 本番環境では適切なセキュリティ設定を行ってください
- 定期的にトークンの更新を行ってください（AccessTokenの有効期限は1時間）
- ログに機密情報が出力されないよう注意してください
- zsh環境では環境変数設定時にシングルクォートやエスケープに注意してください